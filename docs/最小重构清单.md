# TraceDiary 最小重构清单（按风险与工作量排序）

## 说明

- 范围：优先处理服务层重复与职责边界问题。
- 约束：暂不对已有文档进行重构（不搬迁 `README.md` / `AGENTS.md` / `SPEC.md` / `TODO.md`）。
- 目标：在不改变业务行为的前提下，降低重复实现与维护成本。

## P0：收敛 Base64/UTF-8 重复实现（高收益，低风险）

### 问题

- `src/services/sync.ts` 与 `src/services/gitee.ts` 存在重复的文本/Base64 编解码实现。

### 最小改动

1. 在 `sync.ts` 删除重复的文本 Base64 工具实现（保留仅用于字节流解密场景的必要函数）。
2. `sync.ts` 统一复用 `gitee.ts` 的 `encodeBase64Utf8` / `decodeBase64Utf8`。

### 验收标准

- `sync.ts` 不再维护重复的文本 Base64 编解码逻辑。
- 中文与 emoji 内容的编解码回归测试通过。

## P0：metadata 读写统一走 Gitee 网关层（高优先）

### 问题

- `readRemoteMetadataFromGitee()` 与 `uploadMetadataToGitee()`在 `sync.ts` 内直接拼接请求，和 `gitee.ts` 的通用能力重叠。
- `syncMetadataForDiary()` 与 metadata 上传链路存在功能交叠。

### 最小改动

1. `readRemoteMetadataFromGitee()` 内部改为调用 `readGiteeFileContents()`。
2. `uploadMetadataToGitee()` 内部改为调用 `upsertGiteeFile()`。
3. `sync.ts` 仅保留“读取->解密->合并->加密->上传”的编排职责，不再直接操作 Gitee HTTP 细节。

### 验收标准

- `sync.ts` 不再直接发起 Gitee contents API 请求。
- 404、鉴权失败、`sha mismatch` 等行为与当前一致。

## P1：职责边界固化（中优先，低改动）

### 最小改动

1. 明确约定：`gitee.ts` 是唯一 Gitee API 网关层，`sync.ts` 是编排层。
2. 对外导出保持兼容（保留现有方法签名），内部逐步改为薄适配器。

### 验收标准

- 无破坏性接口变更。
- 页面层与 hooks 无需修改调用方式。

## P1：测试目录规范统一（中优先）

### 问题

- `src/test/` 与 `src/__tests__/` 并存，入口语义不统一。

### 最小改动

1. 统一入口到 `src/__tests__/` 体系。
2. 将 `src/test/setup.ts` 迁移为 `src/__tests__/setup.ts`，同步更新 Vitest 配置。
3. 维持 `src/services/__tests__/`、`src/hooks/__tests__/` 就近测试风格，不做大规模迁移。

### 验收标准

- 顶层不再同时维护 `src/test/` 与 `src/__tests__/` 两套入口。
- 单元与集成测试命令可正常执行。

## P2：文档入口优化（本轮冻结）

### 当前决策

- 本轮不对已有文档做结构重构，仅在 `docs/` 新增方案文档。
- 文档索引收敛（如 `docs/INDEX.md`）列为后续可选项，不在本轮执行。

## 回归测试建议

1. `npm run test:unit`
2. `npm run test:integration`
3. `npm run test:e2e`
4. `npm run lint`
5. `npm run build`

## 预期收益

- 减少服务层重复实现，降低后续维护与修复成本。
- 统一 Gitee 访问边界，定位问题更直接，测试覆盖更聚焦。
- 在最小改动前提下提升代码结构清晰度。
