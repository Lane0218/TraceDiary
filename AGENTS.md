# TraceDiary 协作代理规范（AGENTS）

## 1. 适用范围

- 本文档适用于本仓库内的全部开发任务、文档任务与缺陷修复任务。
- 本文档与 `SPEC.md` 同步使用；若两者冲突，以 `SPEC.md` 的产品与技术约束为准。

## 2. 对话与沟通语言

- AI 与用户对话必须使用中文。
- 任务说明、进度更新、风险提示、验收结论必须使用中文。
- 代码中的标识符保持英文；代码注释优先中文（第三方约定要求英文时除外）。

## 3. 工作流（强制）

1. 接收任务后先明确范围：目标、影响文件、验收标准。
2. 实施修改前，先在本文档的 TODO 清单中将对应任务标记为 `DOING`。
3. 完成代码修改后，必须执行完整测试（单元测试 + 集成测试 + E2E）。
4. 若任一测试失败，不得提交；必须先修复或标记 `BLOCKED` 并写明原因。
5. 全部测试通过后，立即提交 Git commit。
6. commit 完成后，立即 push 到远端分支。
7. 将 TODO 状态更新为 `DONE`，并记录完成日期、commit hash 与测试记录。
8. 向用户汇报：改动摘要、完整测试结果、commit hash、push 结果。

## 4. Commit 与 Push 规范（强制）

### 4.1 触发时机

- 每完成一个“代码修改任务”必须主动 `commit + push`，不得攒多个已完成任务再统一提交。
- 一个“代码修改任务”定义为：单一明确目标且可独立验收的一次改动。

### 4.2 commit message 规范

- 遵循 Conventional Commits：`<type>: <中文说明>`
- `type` 必须英文小写，推荐：`feat`、`fix`、`docs`、`refactor`、`test`、`chore`
- 冒号后的说明必须中文，且直述结果，不写空泛描述。

示例：

- `feat: 新增年度总结编辑与存储流程`
- `fix: 修复多设备同步时的sha冲突判定`
- `docs: 更新AGENTS动态TODO清单`
- `test: 补充加密解密与参数升级单元测试`

### 4.3 提交前检查清单

- 改动文件与任务范围一致，无无关变更。
- 不包含敏感信息（Token、密码、明文隐私数据）。
- 对功能改动已完成单元测试、集成测试、E2E，且全部通过。
- TODO 状态已从 `DOING` 更新为 `DONE`（含 commit hash 与测试记录）。

## 5. TODO 动态更新规则（强制）

### 5.1 状态定义

- `TODO`：未开始
- `DOING`：进行中（同一时间最多 1 项）
- `DONE`：已完成、完整测试通过并已 commit+push
- `BLOCKED`：受阻（需标注阻塞原因）

### 5.2 记录格式

每条任务必须包含以下字段：

- `ID`：唯一编号（如 `TD-SEC-003`）
- `任务`：明确动作与对象
- `状态`：`TODO/DOING/DONE/BLOCKED`
- `验收标准`：可验证结果
- `关联文件`：预期变更文件路径
- `测试记录`：执行命令与结果摘要（至少包含单元/集成/E2E）
- `完成记录`：`YYYY-MM-DD / <commit-hash>`（未完成留空）

### 5.3 更新时机

- 开始任务：立刻标记为 `DOING`
- 完成并提交后：立刻标记为 `DONE`，写入日期与 commit hash
- 遇阻塞：立刻标记为 `BLOCKED` 并写明原因

### 5.4 测试红线

- 每个功能任务在标记 `DONE` 前，必须完成完整测试：单元测试、集成测试、E2E。
- 测试执行顺序建议：单元测试 -> 集成测试 -> E2E；任一步失败即停止提交流程。
- 如当前阶段确实无法自动化 E2E，必须先补充人工端到端验证步骤并写入 `测试记录`，且同步创建自动化 E2E 补齐任务。
- 仅文档改动可不执行 E2E，但需在汇报中明确“仅文档改动，无功能行为变化”。

### 5.5 用户授权的必要测试策略（例外）

- 若用户在当前任务中**明确授权**“可不跑全量 E2E / 只跑必要测试”，可作为对 3.3 与 5.4 的一次性例外执行。
- 采用必要测试策略时，最小测试集合为：`npm run lint` + `npm run test:unit` + `npm run test:integration` + 与改动直接相关的目标 E2E 用例（按文件或场景定向执行）。
- “直接相关”判定原则：仅覆盖本次改动触达的主链路与高风险分支（如同步冲突、认证、加解密、上传链路），避免无关全量回归。
- 任务汇报与 `TODO.md` 的 `测试记录` 必须明确写出：已执行测试、未执行的全量项、以及用户授权依据。
- 如用户未明确授权，仍按默认完整测试红线执行。

## 6. 动态 TODO 清单

- 动态 TODO 已拆分到独立文档：`TODO.md`。
- 所有任务状态变更（`TODO/DOING/DONE/BLOCKED`）必须在 `TODO.md` 中更新。
- 执行任务前后，必须同步更新 `TODO.md` 的 `测试记录` 与 `完成记录` 字段。
- 若 `AGENTS.md` 与 `TODO.md` 之间出现不一致，以 `TODO.md` 的实时状态为准，并在同次提交内修复一致性。

## 7. 大任务并行执行策略（强制）

- 对于工作量较大、可拆分且依赖关系清晰的任务，AI 必须主动采用并行多 agents 模式执行，不需要用户额外指定。
- 并行前必须先完成任务拆分与边界定义，确保子任务可并行、可独立验收、可合并。
- 并行执行时应保持统一的验收标准与接口约束，避免重复修改同一文件造成冲突。
- 由主 agent 负责最终汇总、冲突处理、完整测试、commit 与 push，并按本规范更新 `TODO.md` 与对外汇报。
