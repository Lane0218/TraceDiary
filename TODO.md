# TraceDiary 动态 TODO 清单

> 说明：本清单由 AGENTS 拆分而来，作为唯一任务状态源。

> 说明：以下为基于 `SPEC.md` 的完整拆解清单。执行过程中必须持续更新状态与完成记录。

## 0. 快速看板

- 更新时间：`2026-02-15`
- 总任务：`139`
- 状态统计：`DONE=128` / `DOING=0` / `TODO=10` / `BLOCKED=1`
- 当前进行中：`无`

## 1. 任务清单（按模块）

### 6.1 基础工程与项目骨架

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-BASE-001` | `DONE` | 初始化 React + TypeScript + Vite 工程骨架 | 可本地启动并渲染首页 | `package.json` `src/main.tsx` `src/App.tsx` | `npm run test:unit` 通过（1/1）；`npm run test:integration` 通过（1/1）；`npm run test:e2e` 通过（冒烟）；`timeout 10s npm run dev -- --host 127.0.0.1 --port 4174 --strictPort` 启动成功（Vite ready） | `2026-02-08 / 74e583b` |
| `TD-BASE-002` | `DONE` | 接入 Tailwind CSS 并配置基础样式 | 工具类生效且构建通过 | `tailwind.config.*` `src/index.css` | `npm run test:unit` 通过（1/1）；`npm run test:integration` 通过（1/1）；`npm run test:e2e` 通过（冒烟）；`npm run build` 通过 | `2026-02-08 / 064c39d` |
| `TD-BASE-003` | `DONE` | 建立目录结构（components/pages/hooks/services/types/utils） | 目录与 SPEC 对齐 | `src/` | `npm run test:unit` 通过（1/1）；`npm run test:integration` 通过（1/1）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过 | `2026-02-08 / 94001ac` |
| `TD-BASE-004` | `DONE` | 配置 React Router 基础路由（welcome/calendar/editor/yearly-summary） | 页面可路由跳转 | `src/App.tsx` `src/pages/*` | `npm run test:unit` 通过（1/1）；`npm run test:integration` 通过（1/1）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / 252a896` |
| `TD-BASE-005` | `DONE` | 接入 TanStack Query 并提供全局 QueryClient | 页面可使用 query/mutation | `src/main.tsx` | `npm run test:unit` 通过（1/1）；`npm run test:integration` 通过（2/2）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / 4613379` |

### 6.2 认证、安全与密钥管理

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-SEC-001` | `DONE` | 实现首次欢迎页输入（Repo/Token/主密码） | 表单校验通过后进入初始化流程 | `src/pages/welcome.tsx` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-002` | `DONE` | 实现 Gitee 仓库访问校验 | 无效 Token/Repo 可提示错误 | `src/services/gitee.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-003` | `DONE` | 实现 PBKDF2 动态迭代参数校准（200ms~500ms） | 生成并持久化 `kdfParams` | `src/services/crypto.ts` `src/types/config.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-004` | `DONE` | 实现 AES-256-GCM 加解密工具（IV+ciphertext Base64） | 加密后可无损解密 | `src/services/crypto.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-005` | `DONE` | 实现 `encryptedToken` 存储与恢复 | 本地无 Token 明文 | `src/services/crypto.ts` `src/hooks/use-auth.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-006` | `DONE` | 实现 7 天免输主密码机制（不存主密码明文） | 过期后强制重输密码 | `src/hooks/use-auth.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |
| `TD-SEC-007` | `DONE` | 实现 Token 解密失败/失效回退输入流程 | 失败时可补输并覆盖本地密文 | `src/pages/welcome.tsx` `src/hooks/use-auth.ts` | `npm run test:unit` 通过（13/13）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / cb09c7f` |

### 6.3 数据层与本地缓存

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-DATA-001` | `DONE` | 实现 IndexedDB 数据库与对象仓库（diaries/metadata/config） | 可读写并按索引查询 | `src/services/indexeddb.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / f4ddb11` |
| `TD-DATA-002` | `DONE` | 实现 `DiaryEntry` 与 `MetadataEntry` 类型（含 yearly `year + date`） | 类型与 SPEC 一致 | `src/types/diary.ts` `src/types/metadata.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / f4ddb11` |
| `TD-DATA-003` | `DONE` | 实现 metadata 本地解密缓存与远端 `metadata.json.enc` 同步 | 首次加载可拉取并解密 | `src/services/sync.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（6/6）；`npm run test:e2e` 通过（冒烟）；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / f4ddb11` |

### 6.4 核心功能：日历、编辑、年度总结、往年今日

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-FUNC-001` | `DONE` | 实现月历视图与月份切换 | 可切换任意月份并点击日期 | `src/components/calendar/*` `src/pages/calendar.tsx` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-002` | `DONE` | 集成 Milkdown 编辑器并支持基础 Markdown | 可编辑标题/列表/任务列表 | `src/components/editor/*` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-003` | `DONE` | 实现日记创建/读取/编辑流程 | 按日期保存并可回显 | `src/pages/editor.tsx` `src/hooks/use-diary.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-004` | `DONE` | 实现编辑实时写入 IndexedDB | 刷新后本地内容不丢失 | `src/hooks/use-diary.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-005` | `DONE` | 实现 30 秒防抖上传与手动保存立即上传 | 符合触发时机定义 | `src/hooks/use-sync.ts` `src/services/sync.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-006` | `DONE` | 实现年度总结创建/编辑（`YYYY-summary.md.enc`） | 可按年份管理总结 | `src/pages/yearly-summary.tsx` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-007` | `DONE` | 实现“往年今日”查询与预览 | 显示同月同日历史记录 | `src/components/history/*` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-008` | `DONE` | 实现“往年今日”虚拟滚动（react-window） | 历史数据较多时滚动流畅 | `src/components/history/*` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-08 / a71bf95` |
| `TD-FUNC-009` | `DONE` | 修复基础 Markdown 标题/列表视觉差异并新增可编辑源码模式 | 标题（`#`）在可视化模式具备明显层级样式；无序/有序列表样式可见；支持“可视化/源码”双模式切换且内容双向同步、不丢失 | `src/components/editor/markdown-editor.tsx` `src/components/editor/markdown-editor.css` `src/__tests__/integration/markdown-editor.integration.test.tsx` `e2e/specs/daily-edit.spec.ts` `e2e/specs/yearly-summary.spec.ts` `e2e/specs/calendar-history.spec.ts` `e2e/specs/manual-sync-hang-guard.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（50/50）；`npm run test:e2e` 通过（21/21） | `2026-02-11 / e465517` |

### 6.5 同步与冲突解决

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-SYNC-001` | `DONE` | 封装 Gitee 文件读取与写入（优先 Authorization） | 支持 contents API 拉取与更新 | `src/services/gitee.ts` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（26/26）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 5a2eb1c` |
| `TD-SYNC-002` | `DONE` | 实现上传前 SHA 预检与 `expectedSha` CAS 更新 | 更新请求携带正确 `sha` | `src/services/sync.ts` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（26/26）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 247234f` |
| `TD-SYNC-003` | `DONE` | 实现 `sha mismatch` 冲突识别 | 冲突可被稳定检测 | `src/services/sync.ts` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（26/26）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 247234f` |
| `TD-SYNC-004` | `DONE` | 实现冲突弹窗（本地/远端/合并） | 三种分支均可完成 | `src/components/common/*` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/services/sync.ts` `src/hooks/use-sync.ts` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（26/26）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 0616277` |
| `TD-SYNC-005` | `DONE` | 实现离线检测与网络恢复自动重试 | 断网有提示，恢复后自动同步 | `src/hooks/use-sync.ts` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（26/26）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / c991e44` |
| `TD-SYNC-006` | `DONE` | 修复日期切换内容错位并提升云端上传可用性反馈（不含加密改造） | 标题日期与编辑器内容一致；未解锁/未配置时给出明确不可上传提示；手动上传失败可读 | `src/hooks/use-diary.ts` `src/components/editor/markdown-editor.tsx` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/use-sync.ts` `src/__tests__/*` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（28/28）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / cb7823e` |
| `TD-SYNC-007` | `DONE` | 修复 Gitee 默认分支与写入方法导致的同步失败，并补齐可暴露该问题的测试 | 默认分支兼容 `master`；可配置分支；手动与自动上传可成功；测试可覆盖真实失败原因 | `src/types/config.ts` `src/hooks/use-auth.ts` `src/components/auth/auth-modal.tsx` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/services/gitee.ts` `src/services/sync.ts` `src/services/__tests__/*` `src/hooks/__tests__/*` `scripts/e2e-smoke.sh` | `npm run test:unit` 通过（37/37）；`npm run test:integration` 通过（29/29）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / b87ead4` |
| `TD-SYNC-008` | `DONE` | 手动上传失败原因改为按钮旁内联提示，并返回可消费的手动上传结果 | 手动点击失败时在按钮旁显示具体原因；自动上传失败不占用该提示位；日记与年度总结页行为一致 | `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-sync.test.ts` `src/__tests__/integration/*` | `npm run test:unit` 通过（37/37）；`npm run test:integration` 通过（30/30）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 932ab2c` |
| `TD-SYNC-009` | `DONE` | 修复手动上传在并发场景下静默失败（禁止并发并提供明确反馈） | 上传进行中点击手动按钮会给出“请稍候”提示且不静默；按钮在同步中禁用；失败分支均有可消费错误信息 | `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` | `npm run test:unit` 通过（37/37）；`npm run test:integration` 通过（32/32）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / c5cbdf2` |
| `TD-SYNC-010` | `DONE` | 修复上传分支不匹配导致的持续失败并增强失败可观测性 | 配置分支不存在时可自动回退到可用分支并上传成功；手动与自动失败原因可见且不被静默覆盖 | `src/services/sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/services/__tests__/sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` | `npm run test:unit` 通过（38/38）；`npm run test:integration` 通过（32/32）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / 996b21d` |
| `TD-SYNC-011` | `DONE` | 修复上传请求卡死导致长期处于 syncing 的问题（增加超时保护） | 上传请求超时后应自动结束 syncing 并给出明确错误；后续手动上传可继续触发；不再长期显示“正在上传” | `src/hooks/use-sync.ts` `src/hooks/__tests__/use-sync.test.ts` | `npm run test:unit` 通过（38/38）；`npm run test:integration` 通过（33/33）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / 78152db` |
| `TD-SYNC-012` | `DONE` | 修复失败后排队任务持续重入导致同步长时间不退出的问题 | 上传失败/超时后不应立刻重启下一轮上传；busy 提示在退出 syncing 后自动清理；状态可恢复到可重试 | `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-sync.test.ts` | `npm run test:unit` 通过（38/38）；`npm run test:integration` 通过（33/33）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / 07de517` |
| `TD-SYNC-013` | `DONE` | 修复同步中手动上传按钮无响应（移除 disabled 并保留忙碌反馈） | 同步中按钮可点击；点击后立刻提示“当前正在上传，请稍候重试”；不再出现无响应体感 | `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` | `npm run test:unit` 通过（38/38）；`npm run test:integration` 通过（33/33）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / 87ed64f` |
| `TD-SYNC-014` | `DONE` | 增强手动上传点击反馈可见性（点击即显示已触发状态） | 每次点击手动上传都应立即出现可见反馈，且 busy/失败信息不被自动隐藏 | `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` | `npm run test:unit` 通过（38/38）；`npm run test:integration` 通过（33/33）；`npm run test:e2e` 通过；`npm run lint` 通过；`npm run build` 通过 | `2026-02-09 / 6c7962f` |
| `TD-SYNC-015` | `DONE` | 修复同步可靠性与加密模型一致性问题（队列保留/冲突解密/CAS方法/主密码派生密钥） | 失败后保留并可重放最新排队 payload；冲突展示远端明文且不双重加密；metadata CAS 更新使用 PUT；日记数据密钥改为主密码派生并贯通上传链路 | `src/hooks/use-sync.ts` `src/hooks/__tests__/use-sync.test.ts` `src/services/sync.ts` `src/services/__tests__/sync.test.ts` `src/hooks/use-auth.ts` `src/hooks/__tests__/use-auth.test.tsx` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` | `npm run test:unit` 通过（42/42）；`npm run test:integration` 通过（35/35）；`npm run test:e2e` 通过（7/7）；`npm run lint` 通过 | `2026-02-09 / 1fcf734` |
| `TD-SYNC-016` | `DONE` | 修复自动解锁后缺少数据加密密钥导致手动上传异常，并增强同步状态可观测性 | 自动解锁后可直接手动上传；并发触发“请稍候重试”不会在非上传中状态残留；状态区可区分是否存在未提交改动 | `src/hooks/use-auth.ts` `src/services/crypto.ts` `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-auth.test.tsx` | `npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（39/39）；`npm run test:e2e` 通过（17/17）；`npx playwright test e2e/specs/manual-sync-success.spec.ts e2e/specs/manual-sync-busy-clear.spec.ts e2e/specs/daily-edit.spec.ts --project=chromium --repeat-each=3 --retries=0` 通过（9/9）；`npm run build` 通过；`npm run lint` 失败（仓库既有问题：`e2e/helpers/conflict.ts:247 no-unsafe-finally`） | `2026-02-10 / 4578a86` |
| `TD-SYNC-017` | `DONE` | 修复自动同步成功后“最近同步时间”未更新并补齐端到端回归用例 | 自动同步成功后“最近同步”应刷新为最新时间；同页连续两次成功同步时后一次时间严格晚于前一次；新增 E2E 用例稳定通过 | `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `e2e/specs/auto-sync-last-synced.spec.ts` | `npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（40/40）；`npm run test:e2e` 通过（17 passed，1 flaky 重试通过）；`npx playwright test e2e/specs/auto-sync-last-synced.spec.ts --project=chromium --repeat-each=3 --retries=0` 通过（3/3） | `2026-02-10 / ff12550` |
| `TD-SYNC-018` | `DONE` | 新增“手动上传成功后状态应收敛”端到端回归用例（覆盖 pending 提示消失后仍待同步风险） | 点击“手动保存并立即上传”后应先出现“手动上传已触发，正在等待结果...”，随后提示消失；远端上传成功后页面状态应为“云端已同步”且“未提交改动：无” | `e2e/specs/manual-sync-state-consistency.spec.ts` `TODO.md` | `npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts --project=chromium --repeat-each=3 --retries=0` 通过（3/3）；`npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（40/40）；`npm run test:e2e` 通过（19/19） | `2026-02-10 / 382f07b` |
| `TD-SYNC-019` | `DONE` | 修复手动上传后状态不收敛（自动上传悬挂导致长期 syncing）并补齐去重与超时回归测试 | 手动上传成功后若触发同内容自动上传不应重复请求；自动上传悬挂时应在超时后退出 syncing 并给出可重试错误；状态可恢复并与远端结果一致 | `src/hooks/use-sync.ts` `src/hooks/__tests__/use-sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-hang-guard.spec.ts` `e2e/specs/auto-sync-last-synced.spec.ts` `TODO.md` | `npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（43/43）；`npx playwright test e2e/specs/manual-sync-hang-guard.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/auto-sync-last-synced.spec.ts --project=chromium --retries=0` 通过（1/1）；`npm run test:e2e` 通过（20/20） | `2026-02-10 / 4a20958` |
| `TD-SYNC-020` | `DONE` | 落地服务层最小重构（收敛 Base64/UTF-8、统一 metadata 走 Gitee 网关、固化 sync/gitee 职责边界，并统一测试入口） | `sync.ts` 不再维护重复文本 Base64 实现且 metadata 读写不直接发起 contents API；`gitee.ts` 作为唯一 Gitee 网关；测试入口统一为 `src/__tests__/` 且单元/集成/E2E 全部通过 | `src/services/sync.ts` `src/services/gitee.ts` `src/services/__tests__/sync.test.ts` `src/test/setup.ts` `src/__tests__/setup.ts` `vitest.config.ts` `TODO.md` | `npm run test:unit` 通过（48/48）；`npm run test:integration` 通过（43/43）；`npm run test:e2e` 通过（19 passed，1 flaky 重试通过，网络超时后重试成功）；`npm run lint` 失败（仓库既有问题：`e2e/helpers/conflict.ts:247 no-unsafe-finally`）；`npm run build` 通过 | `2026-02-10 / 9733c4e` |
| `TD-SYNC-021` | `DONE` | 清理跨层重复实现（同步状态/手动上传文案、认证表单结构、crypto/sync 基础工具）并收敛公共模块 | `workspace/yearly-summary` 共享同步状态与手动上传文案逻辑；`welcome/auth-modal` 共享认证表单配置；`sync.ts` 不再重复实现可复用的 crypto 基础工具；单元/集成/E2E 全部通过 | `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/components/common/status-hint.tsx` `src/utils/sync-availability.ts` `src/utils/sync-presentation.ts` `src/pages/welcome.tsx` `src/components/auth/auth-modal.tsx` `src/components/auth/auth-form-model.ts` `src/components/auth/auth-form-shared.tsx` `src/services/sync.ts` `src/services/crypto.ts` `src/services/__tests__/sync.test.ts` `TODO.md` | `npm run test:unit` 通过（48/48）；`npm run test:integration` 通过（43/43）；`npm run test:e2e` 通过（20/20）；`npm run lint` 失败（仓库既有问题：`e2e/helpers/conflict.ts:247 no-unsafe-finally`）；`npm run build` 通过 | `2026-02-10 / da84ae1` |
| `TD-SYNC-022` | `DONE` | 重构未提交改动判定为“按 entry 基线 + 内容指纹”，修复手动上传点击即从“无”变“有”与跨日期脏状态污染 | 未提交改动仅在“从未提交”或“提交后内容变化”时显示“有”；手动上传点击不应无条件变脏；切换其他日期不应继承脏状态 | `src/hooks/use-sync.ts` `src/services/indexeddb.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/utils/sync-dirty.ts` `src/hooks/__tests__/use-sync.test.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（48/48）；`npm run test:integration` 通过（45/45）；`npm run test:e2e` 通过（20/20）；`npm run build` 通过 | `2026-02-10 / 70ad5b8` |
| `TD-SYNC-023` | `DONE` | 修复下载同步缺失导致云端日记无法落本地（解锁后自动拉取并按 `modifiedAt` 决策覆盖） | 解锁后自动从远端拉取 metadata 与对应日记并写入 IndexedDB；云端已有 `2100-01-01` 时页面可见；同条目仅在远端 `modifiedAt` 更新时覆盖本地 | `src/services/sync.ts` `src/hooks/use-auth.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/services/__tests__/sync.test.ts` `src/hooks/__tests__/use-auth.test.tsx` `src/__tests__/integration/*` `e2e/specs/*` `TODO.md` | `npm run test:unit` 通过（50/50）；`npm run test:integration` 通过（46/46）；`npm run test:e2e` 通过（21/21） | `2026-02-11 / 42008cc` |
| `TD-SYNC-024` | `DONE` | 将数据密钥改为仅由主密码导出并补齐“内容可解密可读”的端到端校验 | 数据加密主密钥不再依赖 `kdfParams` 随机盐；仅凭主密码可导出同一数据密钥；相关 E2E 必须断言拉取后内容可读且非空 | `src/services/crypto.ts` `src/hooks/use-auth.ts` `src/services/sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/components/editor/markdown-editor.tsx` `src/hooks/use-diary.ts` `src/services/__tests__/crypto.test.ts` `src/services/__tests__/sync.test.ts` `src/hooks/__tests__/use-auth.test.tsx` `src/hooks/__tests__/use-diary.test.ts` `e2e/specs/remote-pull-sync.spec.ts` `TODO.md` | 用户明确授权采用必要测试策略；已执行：`npm run lint`（通过）、`npm run test:unit`（53/53 通过）、`npm run test:integration`（47/47 通过）、`npx playwright test e2e/specs/remote-pull-sync.spec.ts --project=chromium --retries=0`（1/1 通过）；未执行全量 `npm run test:e2e`（已按授权仅执行与改动直接相关用例） | `2026-02-11 / 1965ec9` |
| `TD-SYNC-025` | `DONE` | 移除 fallback 密钥逻辑并强制仅使用主密码派生密钥进行加解密 | 代码中不再保留 fallback 密钥参数、状态与解密分支；上传与下载仅使用主密码派生数据密钥；相关单元/集成/E2E 回归通过 | `src/hooks/use-auth.ts` `src/services/sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-auth.test.tsx` `src/services/__tests__/sync.test.ts` `e2e/specs/upload-encryption.spec.ts` `e2e/specs/conflict-resolution.spec.ts` `TODO.md` | 用户明确授权“可不跑全量 E2E”；已执行：`npm run lint`（通过）、`npm run test:unit`（51/51 通过）、`npm run test:integration`（47/47 通过）、`npx playwright test e2e/specs/remote-pull-sync.spec.ts e2e/specs/upload-encryption.spec.ts --project=chromium --retries=0`（2/2 通过）；未执行全量 `npm run test:e2e`（按授权仅执行最相关用例） | `2026-02-11 / 38f812d` |
| `TD-SYNC-026` | `DONE` | 清空 `.env.e2e` 指向测试仓库并按主密码密钥重建测试密文数据 | 远端旧密文被清空；重建后的 `metadata.json.enc` 与示例日记文件可被主密码成功解密且内容可读 | `TODO.md` | 已执行远端清空与重建脚本并校验通过：清理后文件数 `0`，重建后文件数 `4`（`2100-01-01.md.enc`、`2100-06-06.md.enc`、`2100-summary.md.enc`、`metadata.json.enc`）；回读后使用 `E2E_MASTER_PASSWORD` 可成功解密 `metadata.json.enc` 与 `2100-01-01.md.enc`，内容可读 | `2026-02-11 / 1be61cb` |
| `TD-SYNC-027` | `DONE` | 永久移除自动上传并收敛为“仅手动同步”链路 | 编辑过程不再触发任何自动上传请求；手动上传作为唯一远端写入入口；状态显示与测试用例不再依赖自动上传/自动重试语义 | `src/hooks/use-sync.ts` `src/services/sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/utils/sync-presentation.ts` `src/hooks/__tests__/use-sync.test.ts` `src/services/__tests__/sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/auto-sync-last-synced.spec.ts` `e2e/specs/calendar-history.spec.ts` `e2e/specs/manual-sync-hang-guard.spec.ts` `e2e/specs/manual-sync-failure.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（42/42）；`npm run test:e2e` 通过（20 passed，1 flaky：`manual-sync-failure` 重试通过） | `2026-02-11 / f186e02` |
| `TD-SYNC-028` | `DONE` | 修复手动 Push 后状态不收敛并拆分 Pull/Push 按钮（Push 取消预检读取，冲突统一走弹窗处理） | Push 成功后状态可收敛为“云端已同步”；编辑页支持独立 Pull/Push；Push 不再先读取远端内容；Pull/Push 冲突均可进入冲突弹窗 | `src/services/sync.ts` `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/utils/sync-presentation.ts` `src/utils/sync-dirty.ts` `src/services/__tests__/sync.test.ts` `src/hooks/__tests__/use-sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-*.spec.ts` `SPEC.md` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（54/54）；`npm run test:integration` 通过（43/43）；`npx playwright test e2e/specs/manual-sync-success.spec.ts --project=chromium --retries=0 --workers=1` 通过（1/1）；`npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/yearly-summary.spec.ts --project=chromium --retries=0 --workers=1` 通过（3/3）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium --workers=1 --retries=1 --grep \"保留本地版本\"` 通过（1/1） | `2026-02-11 / e01a8ce` |
| `TD-SYNC-029` | `DONE` | 修复“push 成功后仍显示云端待同步”状态不收敛问题（覆盖刷新后状态恢复） | push 成功后状态应收敛为“云端已同步”；刷新/重进页面后仍保持“云端已同步”；新增回归测试可稳定覆盖该链路 | `src/hooks/use-sync.ts` `src/hooks/__tests__/use-sync.test.ts` `e2e/specs/manual-sync-state-consistency.spec.ts` `e2e/specs/yearly-summary.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npm run test:e2e:full` 首次失败（新 worktree 缺少 `.env.e2e`）；复制主工作区 `.env.e2e` 后重跑 `npm run test:e2e:full` 通过（21/21） | `2026-02-13 / 517ef81` |
| `TD-SYNC-030` | `DONE` | 将“云端待同步/已同步”判定收敛为时间戳方案（本地修改时间 vs 最后同步时间） | push 成功后基于 `lastSyncedAt` 与本地 `modifiedAt` 判定“已同步/待同步”；刷新后状态保持一致；相关单元/集成/E2E 回归通过 | `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-sync.test.ts` `e2e/fixtures/app.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（54/54）；`npm run test:e2e:full` 首轮失败（11 failed，根因为 fixture 仅匹配 `.ProseMirror` 与默认源码模式不兼容）；修复 `e2e/fixtures/app.ts` 后执行 `npx playwright test e2e/specs/manual-sync-success.spec.ts e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/manual-sync-busy-clear.spec.ts --project=chromium --retries=0 --workers=1` 通过（3/3）；`npx playwright test e2e/specs/conflict-resolution.spec.ts e2e/specs/manual-sync-failure.spec.ts e2e/specs/manual-sync-hang-guard.spec.ts e2e/specs/remote-pull-sync.spec.ts e2e/specs/upload-encryption.spec.ts --project=chromium --retries=0 --workers=1` 通过（8/8）；重跑 `npm run test:e2e:full` 通过（21/21） | `2026-02-13 / 4735ee9` |
| `TD-SYNC-031` | `DONE` | 移除“云端待同步/已同步”推断展示，改为 Pull/Push 执行结果与时间展示（不显示耗时） | 工作台与年度总结页均展示 `Pull` 与 `Push` 最近执行状态（未执行/进行中/成功/失败）及绝对时间；不再展示“云端待同步/已同步”胶囊；刷新后状态可恢复；相关单元/集成/E2E 回归通过 | `src/utils/sync-presentation.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` `e2e/fixtures/app.ts` `e2e/specs/manual-sync-*.spec.ts` `e2e/specs/conflict-resolution.spec.ts` `e2e/specs/yearly-summary.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（54/54）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium --workers=1 --retries=1` 通过（4/4）；`npm run test:e2e:full` 通过（21/21） | `2026-02-14 / a4bee89` |
| `TD-SYNC-032` | `DONE` | 同步工具栏 UI 升级为“仪表条 Pro”并引入去重 Toast（同类型全局唯一），新增空内容 Push 拦截 | 工作台与年度总结页同步区视觉升级且布局一致；移除按钮旁内联错误，统一为去重 Toast；空内容（trim 后为空）点击 push 不发请求并提示“当前内容为空，无需 push”；相关单元/集成/E2E 回归通过 | `src/components/common/sync-control-bar.tsx` `src/components/common/toast-center.tsx` `src/hooks/use-toast.ts` `src/App.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/index.css` `src/__tests__/integration/editor.integration.test.tsx` `e2e/fixtures/app.ts` `e2e/specs/manual-sync-*.spec.ts` `e2e/specs/remote-pull-sync.spec.ts` `e2e/specs/yearly-summary.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（55/55）；`npm run test:e2e:full` 首次失败（新 worktree 缺少 .env.e2e）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/sync-toolbar-toast-empty-push-v2 --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary/.worktrees/plan_sync-toolbar-toast-empty-push-v2 --e2e-cmd \"npm run test:e2e:full\"` 后，补跑定向 `npx playwright test e2e/specs/manual-sync-hang-guard.spec.ts e2e/specs/remote-pull-sync.spec.ts e2e/specs/yearly-summary.spec.ts --project=chromium --workers=1 --retries=1` 通过（4/4），最终 `npm run test:e2e:full` 通过（22/22） | `2026-02-14 / f4229fe` |
| `TD-SYNC-033` | `DONE` | 修复 StrictMode 下单次 push 被误判为 stale（前端 2-3 秒提示“当前正在上传”但远端已成功） | 单次点击 push 在开发模式（StrictMode）不再误报“当前正在上传/失败”；手动 push 成功后前端状态与远端结果一致；新增回归测试覆盖 StrictMode 生命周期 | `src/hooks/use-sync.ts` `src/hooks/__tests__/use-sync.test.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 失败（`src/__tests__/integration/app.integration.test.tsx` 3 项失败，属已知阻塞任务 `TD-TEST-013` 的导航迁移断言，不属于本次改动范围）；`npx playwright test e2e/specs/manual-sync-success.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts --project=chromium --retries=0` 通过（1/1） | `2026-02-14 / abb6366` |
| `TD-SYNC-034` | `DONE` | 优化远端 push 提交信息：去除“手动同步”冗余文案并改为北京时间秒级时间戳 | push 到远端时 commit message 不含“手动同步”字样；时间戳为北京时间（`+08:00`）且精确到秒；保持现有冲突处理与上传语义不变；相关测试通过 | `src/services/sync.ts` `src/services/__tests__/sync.test.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（59/59）；`npm run test:integration` 通过（62/62）；`npm run test:e2e:fast` 通过（4/4） | `2026-02-15 / 4cab9bb, 98af599` |

### 6.6 PWA、部署与安全头

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-PWA-001` | `TODO` | 配置 Vite PWA、manifest 与图标资源 | 可安装到主屏幕 | `vite.config.*` `public/manifest.json` | — | — |
| `TD-PWA-002` | `TODO` | 配置 Service Worker 缓存策略（应用壳缓存、日记 NetworkOnly） | 离线可见壳，不缓存日记内容 | `vite.config.*` | — | — |
| `TD-DEP-001` | `TODO` | 配置 `vercel.json` 安全响应头（CSP/HSTS/Referrer/Permissions） | 响应头符合 SPEC | `vercel.json` | — | — |
| `TD-DEP-002` | `TODO` | 补充入口访问控制部署说明（Cloudflare Access/Vercel/Basic Auth） | 部署文档可执行 | `README.md` `SPEC.md` | — | — |

### 6.7 测试与验收

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-TEST-001` | `TODO` | 加密与 KDF 参数升级单元测试 | 核心分支覆盖并通过 | `src/services/__tests__/*` | — | — |
| `TD-TEST-002` | `TODO` | 同步与冲突（CAS/sha mismatch）单元测试 | 冲突分支断言完整 | `src/services/__tests__/*` | — | — |
| `TD-TEST-003` | `TODO` | 认证流程集成测试（首次/7天内/过期/Token失效） | 4 条流程均通过 | `src/hooks/__tests__/*` | — | — |
| `TD-TEST-004` | `DONE` | 关键用户流程 E2E（创建、编辑、同步、冲突） | 核心链路自动化通过 | `e2e/*` | `npm run lint` 通过；`npm run test:unit` 通过（39/39）；`npm run test:integration` 通过（33/33）；`npm run test:e2e` 通过（7/7） | `2026-02-09 / f474348` |
| `TD-TEST-005` | `TODO` | 性能验收（加载、切换日期、往年今日、输入延迟） | 满足 SPEC 指标 | `test-report/*` | — | — |
| `TD-TEST-006` | `TODO` | 兼容性验收（Chrome/Edge/Safari/Firefox/安卓/iOS） | 验收清单全部勾选 | `docs/compatibility-report.md` | — | — |
| `TD-TEST-007` | `DONE` | 补齐 Playwright 端到端关键验收场景（冲突三分支与再冲突、自动重试、年度总结、认证后续、日历导航、安全关键项） | 新增/改造 E2E 用例并通过完整测试（单元/集成/E2E） | `e2e/specs/*` `e2e/fixtures/*` `e2e/helpers/*` | `npm run test:unit` 通过（42/42）；`npm run test:integration` 通过（35/35）；`npm run test:e2e` 通过（17/17）；`npm run lint` 通过 | `2026-02-09 / a58cc80` |
| `TD-TEST-008` | `DONE` | 修复 E2E 假阳性与冲突时序风险（metadata 应用链路断言 + 手动上传使用持久化快照） | metadata 加密断言基于应用真实上传链路；手动上传与冲突流程在快速输入场景下保持一致性并通过完整测试 | `src/services/sync.ts` `src/hooks/use-diary.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/*` `src/__tests__/integration/*` `e2e/specs/*` | `npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（36/36）；`npm run test:e2e` 通过（17/17）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium` 通过（4/4） | `2026-02-09 / 165cd5f` |
| `TD-TEST-009` | `DONE` | 修复冲突 E2E 长跑不稳定（认证重试 + 同步状态收敛 + 冲突注入可观测性） | `conflict-resolution` 在高重复执行下不再因认证抖动或同步状态长期卡住导致失败；日志可区分预写失败与目标请求未触发 | `e2e/fixtures/app.ts` `e2e/specs/conflict-resolution.spec.ts` `e2e/helpers/conflict.ts` `src/hooks/use-sync.ts` | `npm run test:unit` 通过（43/43）；`npm run test:integration` 通过（36/36）；`npm run test:e2e` 通过（17/17）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium --repeat-each=3 --retries=0` 通过（12/12）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium --repeat-each=10 --retries=0` 通过（40/40） | `2026-02-10 / 769aa47` |
| `TD-TEST-010` | `DONE` | 修复 lint 报错 `e2e/helpers/conflict.ts` 中 `no-unsafe-finally` 违规并恢复 lint 全绿 | `npm run lint` 不再报 `no-unsafe-finally`；并通过必要回归（单元/集成 + 冲突相关 E2E） | `e2e/helpers/conflict.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（48/48）；`npm run test:integration` 通过（43/43）；`npx playwright test e2e/specs/conflict-resolution.spec.ts --project=chromium --retries=0` 通过（4/4） | `2026-02-10 / 8c9ec50` |
| `TD-TEST-011` | `DONE` | 移除冗余 E2E 冒烟脚本与 npm 入口 | 仓库不再保留 `test:e2e:smoke` 与 `scripts/e2e-smoke.sh`；无遗留运行入口 | `package.json` `scripts/e2e-smoke.sh` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（48/48）；`npm run test:integration` 通过（43/43）；按用户授权采用必要测试策略，未执行全量 E2E | `2026-02-10 / 6e7d886` |
| `TD-TEST-012` | `TODO` | 落地本地高效测试分层策略（Playwright 并发/分片脚本、用例标签、AGENTS 默认执行规范） | 新增 `test:e2e:fast/changed/last-failed/full/slow/remote/local-shard:*` 脚本；关键 E2E 完成 `@smoke/@slow/@remote` 标签；`AGENTS.md` 明确“默认分层 + 全量门禁”；新增测试策略文档可直接执行 | `playwright.config.ts` `package.json` `e2e/specs/*.spec.ts` `AGENTS.md` `docs/testing-strategy.md` `TODO.md` | — | — |
| `TD-TEST-013` | `BLOCKED` | 测试迁移与断言更新（适配新信息架构与统一导航） | 集成/E2E 不再依赖“会话：已解锁”；导航断言迁移为统一入口并覆盖 `/settings` 可访问；`stats-insights` 跳转断言改为新导航结构并稳定通过 | `src/__tests__/integration/app.integration.test.tsx` `e2e/fixtures/app.ts` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 失败（`app.integration` 3 项失败：当前实现仍为旧导航、无 `/settings` 页面）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 失败（未找到统一导航“统计”入口）；阻塞原因：依赖实现层先合入统一导航（含“设置”）与 `/settings` 路由 | — |

### 6.8 UI 体验优化

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-UI-001` | `DONE` | 提供极简专业风的布局与交互原型 HTML | 可在浏览器中演示导航切换、月份切换与状态反馈逻辑 | `docs/ui-layout-prototype.html` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过 | `2026-02-08 / c45592a` |
| `TD-UI-002` | `DONE` | 调整原型为“欢迎弹层 + 单页工作台（日历与日记/年度总结同屏）” | 欢迎流程以弹层演示，主页面仅保留一个工作台并可切换日记/年度总结 | `docs/ui-layout-prototype.html` `src/hooks/use-diary.ts` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（21/21）；`npm run test:e2e` 通过 | `2026-02-08 / 4a4ff1c` |
| `TD-UI-003` | `DONE` | 落地 blog 同源风格并重构为单页工作台（欢迎弹层 + 日历/日记/年度总结同屏） | 默认进入工作台；认证以弹层呈现；视觉风格与 blog 一致；旧路由可兼容跳转 | `src/App.tsx` `src/index.css` `tailwind.config.js` `src/pages/workspace.tsx` `src/components/auth/*` `src/components/calendar/*` `src/components/history/*` `src/components/editor/*` `src/__tests__/integration/*` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（23/23）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-08 / 661051b` |
| `TD-UI-004` | `DONE` | 精修工作台视觉层级、工具条编排、状态反馈与弹层细节 | 主次区域更清晰；工具条分层；状态可感知；弹层模式切换和错误区更稳定；移动端布局更稳 | `src/pages/workspace.tsx` `src/components/auth/auth-modal.tsx` `src/components/calendar/month-calendar.tsx` `src/components/history/on-this-day-list.tsx` `src/index.css` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（23/23）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / b426bbd` |
| `TD-UI-005` | `DONE` | 收敛日期入口：移除双日期输入框并新增“月标题点击年月选择” | 删除指定文案；无“当前日期/查询日期”输入框；可通过月标题弹层选择年月并联动编辑与往年今日 | `src/pages/workspace.tsx` `src/components/calendar/month-calendar.tsx` `src/pages/calendar.tsx` `src/__tests__/integration/app.integration.test.tsx` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（23/23）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 9ae8d0e` |
| `TD-UI-006` | `DONE` | 优化工作台信息简化与左侧结构（移除条目ID/冗余描述，分离往年今日卡片，缩小日历日期格） | 不显示条目ID；“往年今日”无附加解释文案；往年今日独立于日历卡片；日期格尺寸更紧凑 | `src/pages/workspace.tsx` `src/components/calendar/month-calendar.tsx` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（23/23）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 6f2fe9a` |
| `TD-UI-007` | `DONE` | 重构“日记主页面 + 年度总结独立页”信息架构（移除同级 Tab，新增 `/yearly/:year` 长时写作页与年终提示） | 工作台仅保留日记编辑；可从按钮和年终提示进入年度总结独立页；年度总结支持按自然年切换与保存；返回日记不丢失上下文 | `src/App.tsx` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/pages/calendar.tsx` `src/__tests__/integration/*` | `npm run test:unit` 通过（22/22）；`npm run test:integration` 通过（23/23）；`npm run test:e2e` 通过；`npm run lint` 通过 | `2026-02-09 / 8d66a0b` |
| `TD-UI-008` | `DONE` | 编辑器模式切换收敛为单“源码”按钮并对齐既有按钮样式 | 默认未点击“源码”时展示可视化编辑；点击“源码”后进入源码编辑；按钮样式与站内 `td-btn` 体系一致 | `src/components/editor/markdown-editor.tsx` `src/pages/workspace.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（45/45）；`E2E` 未执行（用户在本任务中明确要求“修改完后不用进行端到端测试”） | `2026-02-11 / b53bd69` |
| `TD-UI-009` | `DONE` | 收敛同步信息展示（移除编辑页分支显示，仅保留云端状态胶囊） | `workspace/yearly` 不展示“分支”与“未提交改动”；欢迎页与设置仍展示分支；云端状态胶囊保留并可反映同步状态 | `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-state-consistency.spec.ts` `e2e/specs/manual-sync-failure.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（45/45）；`npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/manual-sync-failure.spec.ts e2e/specs/manual-sync-success.spec.ts --project=chromium --retries=0 --workers=1` 通过（3/3） | `2026-02-11 / 43b9ae5` |
| `TD-UI-010` | `DONE` | 新增编辑器右下角字数角标、修复往年今日渐隐截断并清理历史日历冗余组件 | 日记与年度总结编辑器右下角显示字数（非空白字符）；往年今日长内容不溢出且底部渐隐自然；移除不再使用的 `calendar` 页面与路由 | `src/components/editor/markdown-editor.tsx` `src/__tests__/integration/markdown-editor.integration.test.tsx` `src/components/history/on-this-day-list.tsx` `src/App.tsx` `src/pages/calendar.tsx` `src/__tests__/integration/calendar.integration.test.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（42/42）；`E2E` 未执行（用户在本任务中明确要求“修改完后不用进行端到端测试”） | `2026-02-11 / 3f9e8d4` |
| `TD-UI-011` | `DONE` | 优化月历年份输入交互与年月弹层视觉统一（支持年份直输即生效、去蓝色、缩窄月份格） | 年份可自然输入中间态并在合法值时即时切换；弹层与主页面风格统一且不使用蓝色强调；12 个月按钮视觉更紧凑 | `src/components/calendar/month-calendar.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（42/42）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 3b77020` |
| `TD-UI-012` | `DONE` | 修复年月弹层定位跳动并收窄月份与年份输入控件 | 不再出现先右后中跳动；月份格和年份输入框更紧凑 | `src/components/calendar/month-calendar.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（42/42）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 2ed232e` |
| `TD-UI-013` | `DONE` | 移除往年今日字数展示并统一编辑器与metadata字数口径（去空白字符数） | 往年今日不再显示字数；编辑器右下角字数与新写入 metadata `wordCount` 口径一致（去空白字符数） | `src/components/history/on-this-day-list.tsx` `src/components/history/on-this-day-utils.ts` `src/components/editor/markdown-editor.tsx` `src/hooks/use-diary.ts` `src/pages/workspace.tsx` `src/services/sync.ts` `src/utils/word-count.ts` `src/__tests__/integration/markdown-editor.integration.test.tsx` `src/__tests__/integration/app.integration.test.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（44/44）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 8fd5bab` |
| `TD-UI-014` | `DONE` | 消除编辑输入时“本地已保存/云端待同步”状态闪烁，收敛为仅异常/慢保存提示与稳定云端状态切换 | 连续输入时状态栏不频闪；本地仅在慢保存/失败时提示；云端状态仅在关键边沿切换 | `src/components/common/status-hint.tsx` `src/hooks/use-sync.ts` `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-sync.test.ts` `src/__tests__/integration/editor.integration.test.tsx` `src/__tests__/integration/status-hint.integration.test.tsx` `e2e/specs/daily-edit.spec.ts` `e2e/specs/yearly-summary.spec.ts` `e2e/fixtures/app.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（46/46）；`npm run test:e2e:fast` 通过（3/3）；`npx playwright test e2e/specs/yearly-summary.spec.ts --project=chromium --retries=0` 通过（2/2）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 29323d7` |
| `TD-UI-015` | `DONE` | 新增写作统计视图（侧栏“往年今日/统计”分段切换 + 统计详情页）并提供累计字数/篇数/连续天数等指标 | 工作台左侧支持“往年今日/统计”切换且默认不影响往年今日首屏可见；统计口径正确（总日记、总年度总结、累计字数、当前连续、最长连续、本年字数）；新增 `/insights` 页面可查看年度汇总与近12月趋势 | `src/App.tsx` `src/pages/workspace.tsx` `src/pages/insights.tsx` `src/components/stats/stats-overview-card.tsx` `src/hooks/use-stats.ts` `src/utils/stats.ts` `src/types/stats.ts` `src/__tests__/unit/stats.unit.test.ts` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（55/55）；`npm run test:integration` 通过（50/50）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 1c6f8e3` |
| `TD-UI-016` | `DONE` | 将同步操作按钮文案统一为 `pull` / `push` | 日记页与年度总结页按钮默认态与进行态文案统一为英文 `pull/pulling...`、`push/pushing...`，相关集成与 E2E 断言同步通过 | `src/pages/workspace.tsx` `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-busy-clear.spec.ts` `e2e/specs/yearly-summary.spec.ts` `SPEC.md` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（51/51）；`npx playwright test e2e/specs/manual-sync-busy-clear.spec.ts e2e/specs/yearly-summary.spec.ts --project=chromium --retries=0 --workers=1` 通过（3/3）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / a72146e` |
| `TD-UI-017` | `DONE` | 修复字数口径回退：确保编辑器角标与 metadata `wordCount` 统计口径一致，并保留往年今日不显示字数 | `workspace` 与 `sync` 写入/回填 `wordCount` 统一为去空白字符数；往年今日列表不展示字数；补充回归断言防止再次回退 | `src/pages/workspace.tsx` `src/services/sync.ts` `src/services/__tests__/sync.test.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（51/51）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 初次因缺少 `.env.e2e` 失败，补齐后通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 0e11160` |
| `TD-UI-018` | `DONE` | 精简统计卡片信息层级（仅保留 3x2 指标）并重排“统计详情”入口到分段切换行 | 统计卡片仅保留 6 个指标，无底部说明文案与底部详情按钮；分段切换两项始终可见并有明确选中态；“统计详情”入口仅在选中统计时显示于切换行右侧 | `src/components/stats/stats-overview-card.tsx` `src/pages/workspace.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（51/51）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 3f06350` |
| `TD-UI-019` | `DONE` | 修复左侧“往年今日/统计”分段条可见性与往年今日列表冗余外框 | 分段条两项始终可见且选中态明确；切换时分段区宽度稳定不抖动；往年今日列表外侧无冗余边框 | `src/pages/workspace.tsx` `src/components/history/on-this-day-list.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `e2e/specs/calendar-history.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（51/51）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / 07a7bf6` |
| `TD-UI-020` | `DONE` | 重构左栏视觉语言（分段控件/往年今日/统计卡片）以提升整体质感 | 左栏分段控件、往年今日、统计卡片在色彩/边界/间距上形成统一设计语言；去除廉价感与拼接感；移动端与桌面端均可正常显示 | `src/pages/workspace.tsx` `src/components/history/on-this-day-list.tsx` `src/components/stats/stats-overview-card.tsx` `TODO.md` | 用户已明确要求“这次不用跑测试”，本任务未执行 `lint/unit/integration/E2E` 自动化测试 | `2026-02-11 / 594b1fc` |
| `TD-UI-021` | `DONE` | 回退左栏为原中性色并移除“往年今日/统计”内容区外层边框 | 左栏恢复非彩色设计；往年今日与统计内容区不再存在额外外层边框，仅保留必要卡片边界；分段切换与详情入口行为不变 | `src/pages/workspace.tsx` `src/components/history/on-this-day-list.tsx` `src/components/stats/stats-overview-card.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（51/51）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-11 / e921d52` |
| `TD-UI-022` | `DONE` | 统一工作台“往年今日/统计/今日日记”内容区高度并补齐回归测试 | 桌面端三块内容区高度一致；移动端保持自适应；新增高度相关集成与 E2E 断言通过 | `src/pages/workspace.tsx` `src/components/history/on-this-day-list.tsx` `src/components/stats/stats-overview-card.tsx` `src/components/editor/markdown-editor.tsx` `src/components/editor/markdown-editor.css` `src/__tests__/integration/app.integration.test.tsx` `src/__tests__/integration/markdown-editor.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（52/52）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1，含高度对齐断言）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-12 / 78290c3` |
| `TD-UI-023` | `DONE` | 优化工作台左右视觉长度与统计卡片密度（避免编辑区偏短与统计单卡过高） | 编辑区在桌面端视觉上不再显著短于左栏；统计卡片高度与密度更紧凑；历史与统计切换体验保持稳定 | `src/pages/workspace.tsx` `src/components/stats/stats-overview-card.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（52/52）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1，含编辑区长度与统计卡片高度断言）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-12 / 900c3a7` |
| `TD-UI-024` | `DONE` | 统一“往年今日/统计”面板高度并将往年今日改为紧凑列表（去预览） | 左侧切换 history/stats 时外层与内容区高度一致；往年今日不再显示正文预览，仅展示紧凑日期条目；统计卡片不出现过高拉伸 | `src/pages/workspace.tsx` `src/components/history/on-this-day-list.tsx` `src/components/stats/stats-overview-card.tsx` `src/utils/sync-dirty.ts` `e2e/specs/stats-insights.spec.ts` `e2e/specs/calendar-history.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1，含 history/stats 等高断言）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1，已适配紧凑列表断言）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / 68bbce5` |
| `TD-UI-025` | `DONE` | 收敛左侧统计态留白（在保持 history/stats 等高前提下下调左侧面板高度） | history/stats 两个 tab 的左侧面板高度保持一致；统计态不再出现大面积空白留白；往年今日紧凑列表与统计卡片展示正常 | `src/pages/workspace.tsx` `src/components/stats/stats-overview-card.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / 98a93d3` |
| `TD-UI-026` | `DONE` | 继续收敛工作台高度：右侧编辑框外内框等高贴合并进一步下调左侧面板高度 | 右侧编辑区外框不再因拉伸出现内框下方大留白；左侧 history/stats 面板高度进一步收敛且两 tab 仍等高；统计卡片密度保持可读 | `src/pages/workspace.tsx` `src/components/stats/stats-overview-card.tsx` `src/components/editor/markdown-editor.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1，含左右底边对齐与统计卡不溢出断言）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / a06f71b` |
| `TD-UI-027` | `DONE` | 微调工作台左栏分段控件（移除左栏“统计详情”按钮、分段去蓝）并修正编辑区标题与源码按钮对齐/间距 | 左栏不再出现“统计详情”冗余按钮；分段控件在选中/未选中态均具备清晰可读对比且不使用蓝色；“日记”标题与“源码”按钮视觉对齐且标题与编辑框间距更舒展 | `src/pages/workspace.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 通过（1/1，含分段对比度与入口回归断言）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / f458fd5` |
| `TD-UI-028` | `DONE` | 将“今日日记”编辑框默认模式改为编辑（源码）模式 | 进入工作台后，日记编辑框默认处于源码可输入态，无需先点“源码”按钮 | `src/pages/workspace.tsx` `e2e/specs/daily-edit.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（53/53）；`npx playwright test e2e/specs/daily-edit.spec.ts --project=chromium --retries=0` 首次失败（用例仍按旧默认可视化断言），修正用例后重跑通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / 1101a59` |
| `TD-UI-029` | `DONE` | 将“今日日记”编辑框默认模式回退为可视化（所见即所得） | 进入工作台后，日记编辑框默认处于可视化编辑态；仅点击“源码”后才进入源码输入态 | `src/pages/workspace.tsx` `e2e/specs/daily-edit.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（54/54）；`npx playwright test e2e/specs/daily-edit.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-13 / c3a611d` |
| `TD-UI-030` | `DONE` | 全仓去除“Workspace/工作台”命名并统一为“日记/diary”（不做兼容） | 用户可见与代码层（路由、页面名、测试标识、E2E helper、文档）不再使用 workspace 术语；默认入口为 `/diary`；不保留 `/workspace` 兼容路由；`TODO.md` 历史记录保持原样 | `src/App.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/pages/insights.tsx` `src/components/auth/auth-modal.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/fixtures/app.ts` `e2e/specs/*.spec.ts` `SPEC.md` `docs/ui-layout-prototype.html` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（54/54）；`npx playwright test e2e/specs/daily-edit.spec.ts e2e/specs/yearly-summary.spec.ts e2e/specs/stats-insights.spec.ts e2e/specs/calendar-history.spec.ts e2e/specs/auth-session.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`）；复制主工作区 `.env.e2e` 后重跑通过（9/9）；`rg -n -i "workspace|工作台" --glob '!.git' --glob '!.worktrees/**' --glob '!TODO.md'` 无命中 | `2026-02-14 / 5c0b76e` |
| `TD-UI-031` | `DONE` | 同步工具栏与同步提示回退为中性灰风格（去蓝色强调） | 日记页与年度总结页同步工具栏不使用蓝色背景/按钮/信息态强调，整体回归中性灰风格且不影响 pull/push/Toast 行为 | `src/index.css` `src/components/common/sync-control-bar.tsx` `src/components/common/toast-center.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（55/55）；`npm run test:e2e:fast` 通过（4/4） | `2026-02-14 / 994e551` |
| `TD-UI-032` | `DONE` | 同步工具栏背景色与日历背景保持一致（去除偏色叠加） | 同步工具栏背景与日历卡片背景完全一致（同色值来源）；视觉上不再偏暖/偏蓝；不影响 pull/push/Toast 功能与状态展示 | `src/index.css` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（55/55）；`npm run test:e2e:fast` 首次失败（`manual-sync-success` 出现 push 失败）；重跑 `npx playwright test e2e/specs/manual-sync-success.spec.ts --project=chromium --retries=0` 通过（1/1）；复跑 `npm run test:e2e:fast` 通过（4/4） | `2026-02-14 / 5a4295b` |
| `TD-UI-033` | `DONE` | 统一三页导航栏并将“会话”改为“设置”（进入设置页进行配置） | 日记/年度总结/统计三页使用同一导航结构；顶部移除“会话状态胶囊”；“设置”入口统一跳转设置页；设置页可完成配置并保留锁定入口；整体视觉保持当前简约风格 | `src/components/common/app-header.tsx` `src/pages/settings.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/pages/insights.tsx` `src/App.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/fixtures/app.ts` `e2e/specs/stats-insights.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（56/56）；`npm run test:e2e:full` 通过（22/22） | `2026-02-14 / 97228db` |
| `TD-UI-034` | `DONE` | 优化月历年份步进控件为“箭头按钮 + 输入框”并保留直输跳转 | 年份选择器支持点击左右箭头按年增减；保留输入合法年份即时跳转；边界年份按钮禁用且样式清晰；整体视觉与现有中性风格一致 | `src/components/calendar/month-calendar.tsx` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（57/57）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-15 / 81550f7` |
| `TD-UI-035` | `DONE` | 精简年月弹层文案：移除“年份”标签并将“回到本月”改为图标按钮 | 弹层中年份区域不再显示“年份”字样；回到当前月份入口改为仅图标按钮且具备可访问名称；保留年份输入与箭头步进全部功能 | `src/components/calendar/month-calendar.tsx` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（116/116，含 `.worktrees` 重复测试文件）；`npm run test:integration` 通过（114/114，含 `.worktrees` 重复测试文件）；`npx playwright test e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-15 / 65445f5` |
| `TD-UI-036` | `DONE` | 点击 pull/push 任一按钮后，两个按钮在进行中同时禁用 | 触发 pull 或 push 后，两按钮均立即进入禁用态；请求结束后恢复；不影响现有成功/失败提示与冲突流程 | `src/components/common/sync-control-bar.tsx` `src/index.css` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-busy-clear.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（57/57）；`npm run test:e2e:fast` 首次失败（新 worktree 缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/push-pull-dual-disable --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary/.worktrees/plan-push-pull-dual-disable --e2e-cmd \"npm run test:e2e:fast\"` 后重跑通过（4/4） | `2026-02-15 / 28ebb5d` |
| `TD-UI-037` | `DONE` | 重构设置页交互为页内直配（移除“配置”二次弹窗入口）并移除主动锁定按钮入口 | 进入设置页可直接完成首次配置/解锁/Token 更新；设置页不再出现“配置”按钮与二次弹窗；保留日记/统计/年度总结未解锁阻断弹窗；全局不再提供“立即锁定”按钮 | `src/pages/settings.tsx` `src/components/auth/auth-modal.tsx` `src/components/auth/auth-panel.tsx` `src/pages/welcome.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/auth-setup.spec.ts` `e2e/specs/auth-session.spec.ts` `TODO.md` | 风险分级：高；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（57/57）；`npx playwright test e2e/specs/auth-setup.spec.ts e2e/specs/auth-session.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --repo /home/ljcwsl/0-code/TraceDiary --branch plan/settings-inline-auth-panel --e2e-cmd "npx playwright test e2e/specs/auth-setup.spec.ts e2e/specs/auth-session.spec.ts --project=chromium --retries=0"` 后重跑通过（5/5）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 502a1f8` |
| `TD-UI-038` | `DONE` | 年度总结页对齐日记页编辑布局并统一年份切换控件 | 年度总结页使用与日记页一致的“同步栏在上 + 编辑卡片在下”结构；年份切换交互与日历弹层一致（箭头步进+输入跳转）；编辑区在桌面端明显加长并接近铺满页面 | `src/pages/yearly-summary.tsx` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/yearly-summary.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（57/57）；`npx playwright test e2e/specs/yearly-summary.spec.ts e2e/specs/calendar-history.spec.ts --project=chromium --retries=0` 通过（3/3）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-15 / c4172c6` |
| `TD-UI-039` | `DONE` | 设置页去冗余并支持 ready 状态下直接编辑仓库/分支/Token | 设置页改为单层紧凑布局，移除解释性冗余文案与二级嵌套头；ready 状态可提交仓库/分支/Token 变更并即时校验生效；继续不提供“立即锁定”按钮 | `src/pages/settings.tsx` `src/components/auth/auth-panel.tsx` `src/components/auth/auth-form-model.ts` `src/hooks/use-auth.ts` `src/hooks/__tests__/use-auth.test.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/settings-update.spec.ts` `TODO.md` | 风险分级：高；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（60/60）；`npx playwright test e2e/specs/auth-setup.spec.ts e2e/specs/auth-session.spec.ts e2e/specs/settings-update.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --repo /home/ljcwsl/0-code/TraceDiary --branch plan/settings-page-compact-editable --e2e-cmd "npx playwright test e2e/specs/auth-setup.spec.ts e2e/specs/auth-session.spec.ts e2e/specs/settings-update.spec.ts --project=chromium --retries=0"` 后发现新增 settings 用例失败，修复后重跑同命令通过（7/7）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 46fadd6` |
| `TD-UI-040` | `DONE` | 优化同步按钮进行中视觉与 Toast 生命周期（移除 `...`、进行中常驻到结束后被结果顶替） | 按钮进行中不再显示 `pulling.../pushing...`，改为 `pull/push + 小圆点脉冲`；`pull/push` 进行中提示不自动消失，成功/失败结束提示到达后顶替进行中提示并按原时长自动消失 | `src/components/common/sync-control-bar.tsx` `src/index.css` `src/hooks/use-toast.ts` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/hooks/__tests__/use-toast.test.tsx` `src/__tests__/integration/editor.integration.test.tsx` `e2e/specs/manual-sync-busy-clear.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 首次失败（worktree 缺少依赖，`eslint: not found`），挂载主工作区 `node_modules` 后通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（59/59）；`npm run test:e2e:fast` 首次失败（缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/sync-toast-motion-polish --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_sync-toast-motion-polish --e2e-cmd "npm run test:e2e:fast"` 后重跑通过（4/4）；`npx playwright test e2e/specs/manual-sync-busy-clear.spec.ts --project=chromium --retries=0` 通过（1/1） | `2026-02-15 / 36b519e` |
| `TD-UI-041` | `DONE` | 继续精简设置页 ready 区域：移除重复状态展示并收敛文案到必要信息 | 设置页 ready 区域不再重复出现 `READY/状态卡/状态行`；仅保留可编辑项与必要说明；文案简洁且无重复解释 | `src/components/auth/auth-panel.tsx` `e2e/specs/settings-update.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/settings-update.spec.ts --project=chromium --retries=0` 通过（2/2）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 35a06d1` |
| `TD-UI-042` | `DONE` | 设置页进一步压缩留白并重排布局（去空占位、去无意义说明、桌面双列） | 设置页不再出现顶部/底部大空白；去除“仅保留必要项”说明；桌面端字段采用双列排布降低右侧留白，移动端保持单列可用 | `src/pages/settings.tsx` `src/components/auth/auth-panel.tsx` `e2e/specs/settings-update.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/settings-update.spec.ts --project=chromium --retries=0` 通过（2/2）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / a98e819` |
| `TD-UI-043` | `DONE` | 统计页升级为图表主导仪表盘（保留明细表并新增月度趋势/年度对比可视化） | 统计页首屏展示 KPI + 月度趋势主图；新增年度对比图；年度表格保留并支持明细核对；移动端保持同密度可用 | `src/pages/insights.tsx` `src/components/stats/monthly-trend-chart.tsx` `src/components/stats/yearly-comparison-chart.tsx` `src/components/stats/yearly-stats-table.tsx` `src/utils/stats.ts` `src/types/stats.ts` `src/__tests__/unit/stats.unit.test.ts` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 首次失败（worktree 缺少依赖，`eslint: not found`），挂载主工作区 `node_modules` 后通过；`npm run test:unit` 通过（59/59）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/insights-dashboard-svg-v1 --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_insights-dashboard-svg-v1 --e2e-cmd \"npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0\"` 后重跑通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / dac12c4` |
| `TD-UI-044` | `DONE` | 重构同步栏为“主状态 + 悬浮明细”并去除主栏 pull/push 双气泡冗余 | 主栏仅展示全局同步状态与 pull/push 按钮；pull/push 结果与时间改为 hover/focus/tap 可见明细；失败不在主栏常驻展示但可在 toast 与明细中回看；日记页与年度页复用同一同步栏组件 | `src/components/common/sync-control-bar.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/index.css` `TODO.md` | 风险分级：中；`npm run lint` 通过（首次失败：`eslint: not found`，已在 worktree 挂载主工作区 `node_modules` 后重跑通过）；`npm run test:unit` 通过（58/58）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/manual-sync-busy-clear.spec.ts e2e/specs/yearly-summary.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/syncbar-hover-details --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_syncbar-hover-details --e2e-cmd \"npx playwright test e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/manual-sync-busy-clear.spec.ts e2e/specs/yearly-summary.spec.ts --project=chromium --retries=0\"` 后重跑通过（4/4）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 2773497` |
| `TD-UI-045` | `DONE` | 统计页文案收敛与可视区优化（去说明性副文案、移除年度总结篇数列、图表改为无横向滚动） | 统计页标题区不再出现说明性副文案；年度表格不再展示“年度总结篇数”；近12月趋势与年度对比在桌面端默认无需横向滚动即可完整展示 | `src/pages/insights.tsx` `src/components/stats/monthly-trend-chart.tsx` `src/components/stats/yearly-comparison-chart.tsx` `src/components/stats/yearly-stats-table.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 首次失败（worktree 缺少依赖，`eslint: not found`），挂载主工作区 `node_modules` 后通过；`npm run test:unit` 通过（59/59）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/insights-polish-no-scroll --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_insights-polish-no-scroll --e2e-cmd \"npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0\"` 后重跑通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / c293293` |
| `TD-UI-046` | `DONE` | 同步栏改为仅点击小气泡展开明细，并在失败态展示完整失败原因（含刷新后保留） | 仅点击“已同步/未同步/同步中”小气泡触发明细；移除整栏 hover 触发；失败态在明细中显示完整原因并可刷新后继续查看；日记页与年度页复用同一实现 | `src/components/common/sync-control-bar.tsx` `src/pages/diary.tsx` `src/pages/yearly-summary.tsx` `src/utils/sync-presentation.ts` `src/index.css` `e2e/specs/manual-sync-failure.spec.ts` `e2e/specs/manual-sync-hang-guard.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（59/59）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/manual-sync-busy-clear.spec.ts e2e/specs/manual-sync-state-consistency.spec.ts e2e/specs/manual-sync-failure.spec.ts e2e/specs/manual-sync-hang-guard.spec.ts --project=chromium --retries=0` 通过（4/4）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 17c38d2` |
| `TD-UI-047` | `DONE` | 统计页改造为“年度卡片摘要 + 年度热力图（按日记日期、按字数着色）”，并移除重复统计与年度表格 | 导航栏文案改为“数据统计”；统计详情页不再重复展示日记页已有 KPI；年度区域提供摘要卡片与按 `daily.date` 聚合的年度热力图（色阶基于当日字数，非篇数）；移除年度汇总表格并保证桌面/移动端无异常大留白 | `src/components/common/app-header.tsx` `src/pages/insights.tsx` `src/components/stats/yearly-summary-cards.tsx` `src/components/stats/yearly-activity-heatmap.tsx` `src/utils/stats-heatmap.ts` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（63/63）；`npm run test:integration` 通过（62/62）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/insights-year-heatmap-cards --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_insights-year-heatmap-cards --e2e-cmd \"npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0\"` 后重跑通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 9b1801e` |
| `TD-UI-048` | `DONE` | 统计页热力图改造为“年份箭头输入 + 周一开头 + 右侧信息区”，消除右侧大面积留白 | 热力图年份选择采用与日历体系一致的箭头+输入；周起始改为周一；右侧空白改为信息区（图例+选中日期+年度摘要）；整体视觉更均衡且无明显大块空白 | `src/components/stats/yearly-activity-heatmap.tsx` `src/utils/stats-heatmap.ts` `src/__tests__/unit/stats-heatmap.unit.test.ts` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（76/76）；`npm run test:integration` 通过（67/67）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/insights-heatmap-monday-picker --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_insights-heatmap-monday-picker --e2e-cmd \"npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0\"` 后发现选择器断言冲突，修正断言并重跑同命令通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / c9dc785` |
| `TD-UI-049` | `DONE` | 将导入入口从日记页迁移到设置页，并统一导入/导出为同一暖色数据管理视觉体系 | 设置页提供可用导入与导出入口；日记页不再展示导入入口；导入流程（预检/冲突/结果/自动上传）行为不回退；导入与导出卡片样式统一且与现有中性主界面分层共存 | `src/pages/diary.tsx` `src/pages/settings.tsx` `src/components/common/import-data-panel.tsx` `src/components/common/export-data-panel.tsx` `src/index.css` `src/__tests__/integration/import.integration.test.tsx` `e2e/specs/import.spec.ts` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（75/75）；`npm run test:integration` 通过（67/67）；`npx playwright test e2e/specs/import.spec.ts` 首次失败（worktree 缺少 `.env.e2e`），复制主工作区 `.env.e2e` 后重跑通过（1/1）；`npm run test:e2e:full` 通过（26 passed，1 flaky 重试通过）；`npx playwright test e2e/specs/stats-insights.spec.ts` 通过（1/1，修复热力图年份切换稳定性） | `2026-02-15 / dd5b3ce` |
| `TD-UI-050` | `DONE` | 精简导入/导出相关文案，仅保留必要信息 | 设置页导入与导出面板仅保留“导入/导出”标题与按钮；进行中状态改为按钮左侧闪动圆点 + Toast（与 pull/push 反馈模式一致）；不影响导入导出行为与现有测试链路 | `src/components/common/import-data-panel.tsx` `src/components/common/export-data-panel.tsx` `src/components/common/import-conflict-dialog.tsx` `src/components/common/import-result-dialog.tsx` `src/index.css` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（76/76）；`npm run test:integration` 通过（67/67）；`npx playwright test e2e/specs/import.spec.ts e2e/specs/export-data.spec.ts --project=chromium --retries=0` 首次失败（并行执行导致导出“无数据”断言受污染），追加 `--workers=1` 串行重跑通过（3/3） | `2026-02-15 / ac1e1fe` |
| `TD-UI-051` | `DONE` | 统计页信息架构重排与图表留白优化（统一层级、月度指标右置、热力图图例/选中信息下置） | 统计页标题层级清晰（避免“年度对比/年度洞察/年度热力图”并列混乱）；月度趋势指标不再位于图表上下造成大面积留白；热力图右侧仅保留年度关键指标，图例与选中日期移至热力图下方；桌面端不出现明显不合理空白块 | `src/pages/insights.tsx` `src/components/stats/monthly-trend-chart.tsx` `src/components/stats/yearly-activity-heatmap.tsx` `src/__tests__/integration/app.integration.test.tsx` `e2e/specs/stats-insights.spec.ts` `TODO.md` | 风险分级：中；`npm run lint` 首次失败（worktree 缺少依赖，`eslint: not found`），挂载主工作区 `node_modules` 后重跑通过；`npm run test:unit` 通过（76/76）；`npm run test:integration` 通过（67/67）；`npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`），执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/insights-ia-layout-polish --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_insights-ia-layout-polish --e2e-cmd \"npx playwright test e2e/specs/stats-insights.spec.ts --project=chromium --retries=0\"` 后重跑通过（1/1）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁） | `2026-02-15 / 4e05f33` |

### 6.9 数据导入（v1.1）

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-IMP-001` | `DONE` | 实现 md/txt 文件名解析器（`YYYY-MM-DD` 与 `YYYY-summary`） | 可正确识别 `daily`/`yearly_summary` 并产出结构化结果 | `src/services/import.ts` `src/types/diary.ts` | 风险分级：高；`npm run lint` 通过；`npm run test:unit` 通过（67/67）；`npm run test:integration` 通过（64/64）；`npx playwright test e2e/specs/import.spec.ts --project=chromium --retries=0` 首次失败（缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/import-auto-batch-push --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_import-auto-batch-push --e2e-cmd \"npx playwright test e2e/specs/import.spec.ts --project=chromium --retries=0\"` 后重跑通过（1/1） | `2026-02-15 / 8bf65d2` |
| `TD-IMP-002` | `DONE` | 实现批量导入预检（有效/冲突/无效分类） | 导入前能输出三类列表，错误文件可定位 | `src/services/import.ts` `src/pages/diary.tsx` | 风险分级：高；同 `TD-IMP-001` 测试集全部通过 | `2026-02-15 / 8bf65d2` |
| `TD-IMP-003` | `DONE` | 实现冲突逐条确认（覆盖/跳过）写入流程 | 同日期/同年份冲突可逐条决策并正确落库 | `src/components/common/import-conflict-dialog.tsx` `src/pages/diary.tsx` | 风险分级：高；同 `TD-IMP-001` 测试集全部通过 | `2026-02-15 / 8bf65d2` |
| `TD-IMP-004` | `DONE` | 实现导入结果汇总反馈（成功/跳过/失败） | 完成后可查看汇总统计与失败明细 | `src/components/common/import-result-dialog.tsx` `src/pages/diary.tsx` | 风险分级：高；同 `TD-IMP-001` 测试集全部通过 | `2026-02-15 / 8bf65d2` |
| `TD-IMP-005` | `DONE` | 补齐导入单元/集成/E2E 测试 | 覆盖命名识别、冲突处理、异常跳过、部分失败容错 | `src/services/__tests__/import.test.ts` `src/services/__tests__/import-sync.test.ts` `src/__tests__/integration/import.integration.test.tsx` `e2e/specs/import.spec.ts` | 风险分级：高；同 `TD-IMP-001` 测试集全部通过 | `2026-02-15 / 8bf65d2` |

### 6.12 数据导出（v1.1）

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-EXP-001` | `DONE` | 实现设置页明文导出入口与 ZIP 导出流程（含 manifest）并补齐分层测试 | 设置页可触发明文导出并下载 `trace-diary-export-YYYYMMDD-HHmmss.zip`；产物包含 `diaries/*.md`、`summaries/*-summary.md` 与 `manifest.json`；未解锁/无数据/部分失败反馈符合 SPEC 4.8；导出过程不触发 Push/Pull | `src/pages/settings.tsx` `src/components/common/export-data-panel.tsx` `src/services/export.ts` `src/types/export.ts` `src/index.css` `src/services/__tests__/export.test.ts` `src/__tests__/integration/export.integration.test.tsx` `e2e/specs/export-data.spec.ts` `package.json` `package-lock.json` `TODO.md` | 风险分级：中；`npm run lint` 通过；`npm run test:unit` 通过（63/63）；`npm run test:integration` 通过（65/65）；`npx playwright test e2e/specs/export-data.spec.ts --project=chromium --retries=0` 首次失败（worktree 缺少 `.env.e2e`）；执行 `bash /home/ljcwsl/.codex/skills/main-worktree-flow/scripts/worktree-flow.sh fix-e2e-env --branch plan/export-settings-only --repo /home/ljcwsl/0-code/TraceDiary --worktree /home/ljcwsl/0-code/TraceDiary-wt-plan_export-settings-only --e2e-cmd \"npx playwright test e2e/specs/export-data.spec.ts --project=chromium --retries=0\"` 后重跑通过（2/2）；未执行全量 `npm run test:e2e`（本任务未命中全量门禁，已执行与改动直接相关目标 E2E） | `2026-02-15 / 961dbee` |

### 6.10 文档维护

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-DOC-001` | `DONE` | 补充导入功能规格与 TODO 拆解（md/txt 文件名识别 + 系统自动生成 metadata） | `SPEC.md` 明确导入输入格式、识别规则、冲突策略、验收标准；`TODO.md` 新增导入任务组 | `SPEC.md` `TODO.md` | `npm run test:unit` 通过（35/35）；`npm run test:integration` 通过（28/28）；`npm run test:e2e` 通过（冒烟） | `2026-02-09 / 05c0fb7` |
| `TD-DOC-002` | `DONE` | 在 AGENTS 增加“大工作量任务默认并行多 agents 执行”规范 | `AGENTS.md` 明确要求 AI 对重任务主动采用并行多 agents，不依赖用户显式指定 | `AGENTS.md` `TODO.md` | `npm run test:unit` 通过（42/42）；`npm run test:integration` 通过（35/35）；`npm run test:e2e` 通过（14 passed，3 flaky 重试通过） | `2026-02-09 / 6c99c2c` |
| `TD-DOC-003` | `DONE` | 在 AGENTS 增加“用户明确授权时可采用必要测试策略”的执行规范 | AGENTS 明确必要测试策略的触发条件、最小测试集合、结果披露要求；不影响默认完整测试红线 | `AGENTS.md` `TODO.md` | 仅文档改动，无功能行为变化；未执行单元/集成/E2E | `2026-02-10 / a72056b` |
| `TD-DOC-004` | `DONE` | 更新 SPEC 同步策略为“仅手动 pull/push”，并移除自动上传相关 E2E 用例 | `SPEC.md` 明确不再自动上传；仅保留手动 push 与手动/解锁触发 pull 的描述；自动上传专属 E2E 用例已移除 | `SPEC.md` `e2e/specs/auto-sync-last-synced.spec.ts` `TODO.md` | `npm run lint` 通过；`npm run test:unit` 通过（51/51）；`npm run test:integration` 通过（45/45）；`npx playwright test e2e/specs/manual-sync-success.spec.ts e2e/specs/remote-pull-sync.spec.ts --project=chromium --retries=0` 通过（2/2）；`npx playwright test --list --project=chromium` 显示总计 `20 tests in 13 files`（已移除自动上传专属 E2E） | `2026-02-11 / 5afde94` |
| `TD-DOC-005` | `DONE` | 在 AGENTS 增加“接任务后先重命名 tmux pane”的执行规范 | `AGENTS.md` 明确要求每次接收任务先查看 pane 编号，再按任务语义重命名 pane，且提供命令示例 | `AGENTS.md` `TODO.md` | `npm run lint` 通过；仅文档改动，无功能行为变化，未执行 `npm run test:unit` / `npm run test:integration` / E2E | `2026-02-12 / b5ac147` |
| `TD-DOC-006` | `DONE` | 在 AGENTS 补充 pane 定位与复用规范（`pane_index`、`session/window`、同任务不重复改名） | AGENTS 明确使用 `pane_index`（纯数字）而非 `%pane_id`；重命名命令必须显式绑定 `session:window.pane_index`；同一任务连续微调无需重复改名，仅任务语义切换时改名 | `AGENTS.md` `TODO.md` | `npm run lint` 通过；仅文档改动，无功能行为变化，未执行单元/集成/E2E | `2026-02-13 / 2700d07` |
| `TD-DOC-007` | `DONE` | 压缩 AGENTS 的 pane 重命名说明并改为基于 `TMUX_PANE` 定位当前 Codex pane | AGENTS 第 3 节以最少步骤明确：通过 `TMUX_PANE` 反查 `session:window.pane_index` 后重命名并回读；禁止用不带 `-t` 的 `#S:#I.#P` 判定当前 pane | `AGENTS.md` `TODO.md` | 风险分级：低（仅文档）；`npm run lint` 通过；仅文档改动，无功能行为变化，未执行单元/集成/E2E | `2026-02-14 / 9d87dea` |
| `TD-DOC-008` | `DONE` | 调整 AGENTS 测试策略：仅文档改动可不执行任何测试（含 lint） | AGENTS 明确“仅文档改动且无功能行为变化”时可不执行自动化测试；相关条目无互相冲突描述 | `AGENTS.md` `TODO.md` | 风险分级：低（仅文档）；按用户授权本任务未执行自动化测试（`lint/unit/integration/E2E`） | `2026-02-14 / 4f1280e` |

### 6.11 开发效率与工具

| ID | 状态 | 任务 | 验收标准 | 关联文件 | 测试记录 | 完成记录 |
| --- | --- | --- | --- | --- | --- | --- |
| `TD-DEV-001` | `DONE` | 新增 WezTerm + tmux 四窗格 Codex 启动脚本（默认命名且支持后续手动重命名） | 一条命令可创建/附着 `2x2` 四窗格并在每个 pane 启动 `codex`；初始 pane 名称可见；可通过 `tmux select-pane -T` 手动改名 | `scripts/start-codex4.sh` `docs/codex-parallel.md` `TODO.md` | `bash -n scripts/start-codex4.sh` 通过；`npm run lint` 通过；`npm run test:unit` 通过（58/58）；用户明确要求“这个就不用测试了”，未继续执行 `npm run test:integration` 与 E2E | `2026-02-12 / 0fb306a` |
