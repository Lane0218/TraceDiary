<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TraceDiary Agent 任务看板</title>
    <style>
      :root {
        --bg: #f6f4ee;
        --panel: rgba(255, 255, 255, 0.88);
        --ink: #1e2329;
        --muted: #5c6672;
        --line: rgba(30, 35, 41, 0.16);
        --done: #1d4ed8;
        --doing: #b45309;
        --todo: #475569;
        --blocked: #be123c;
        --shadow: 0 16px 40px rgba(30, 35, 41, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 8% 10%, rgba(15, 118, 110, 0.16), transparent 36%),
          radial-gradient(circle at 92% 84%, rgba(29, 78, 216, 0.14), transparent 35%),
          var(--bg);
      }
      .wrap {
        max-width: 1320px;
        margin: 0 auto;
        padding: 24px;
      }
      .hero {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 20px 24px;
      }
      .hero h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.02em;
      }
      .meta {
        margin-top: 8px;
        color: var(--muted);
        font-size: 13px;
      }
      .toolbar {
        margin-top: 18px;
        display: grid;
        grid-template-columns: 1.6fr 0.9fr;
        gap: 12px;
      }
      .toolbar input,
      .toolbar select {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.92);
        color: var(--ink);
        padding: 10px 12px;
        font-size: 14px;
      }
      .stats {
        margin-top: 14px;
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
      }
      .card {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        padding: 10px 12px;
      }
      .card .label {
        display: block;
        color: var(--muted);
        font-size: 12px;
      }
      .card .value {
        margin-top: 4px;
        font-size: 24px;
        font-weight: 700;
      }
      .panel {
        margin-top: 16px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.9);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        vertical-align: top;
        text-align: left;
      }
      thead th {
        position: sticky;
        top: 0;
        background: rgba(244, 241, 233, 0.95);
        z-index: 2;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      tbody tr:hover {
        background: rgba(15, 118, 110, 0.06);
      }
      .status {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        padding: 3px 8px;
        letter-spacing: 0.03em;
      }
      .status-DONE {
        background: rgba(29, 78, 216, 0.12);
        color: var(--done);
      }
      .status-DOING {
        background: rgba(180, 83, 9, 0.14);
        color: var(--doing);
      }
      .status-TODO {
        background: rgba(71, 85, 105, 0.14);
        color: var(--todo);
      }
      .status-BLOCKED {
        background: rgba(190, 18, 60, 0.14);
        color: var(--blocked);
      }
      .mono {
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, monospace;
        font-size: 12px;
      }
      .scroll {
        max-height: 78vh;
        overflow: auto;
      }
      @media (max-width: 960px) {
        .toolbar {
          grid-template-columns: 1fr;
        }
        .stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="hero">
        <h1>TraceDiary Agent 任务看板</h1>
        <p class="meta" id="meta"></p>
        <div class="toolbar">
          <input id="searchInput" placeholder="搜索：ID / 任务 / 状态" />
          <select id="statusSelect"></select>
        </div>
        <div class="stats">
          <div class="card"><span class="label">总任务</span><span class="value" id="statTotal">0</span></div>
          <div class="card"><span class="label">DONE</span><span class="value" id="statDone">0</span></div>
          <div class="card"><span class="label">DOING</span><span class="value" id="statDoing">0</span></div>
          <div class="card"><span class="label">TODO</span><span class="value" id="statTodo">0</span></div>
          <div class="card"><span class="label">BLOCKED</span><span class="value" id="statBlocked">0</span></div>
        </div>
      </section>
      <section class="panel">
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th style="width: 14%">ID</th>
                <th style="width: 12%">状态</th>
                <th style="width: 54%">任务</th>
                <th style="width: 20%">完成记录</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      const AUTO_REFRESH_MS = 3000
      const STATUS_OPTIONS = ['ALL', 'DONE', 'DOING', 'TODO', 'BLOCKED']

      let allTasks = []
      let lastGeneratedAt = ''

      const searchInput = document.getElementById('searchInput')
      const statusSelect = document.getElementById('statusSelect')
      const tableBody = document.getElementById('tableBody')
      const meta = document.getElementById('meta')

      const statTotal = document.getElementById('statTotal')
      const statDone = document.getElementById('statDone')
      const statDoing = document.getElementById('statDoing')
      const statTodo = document.getElementById('statTodo')
      const statBlocked = document.getElementById('statBlocked')

      function escapeHtml(raw) {
        return String(raw)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;')
      }

      function formatBeijingTime(raw) {
        const parsed = new Date(raw)
        if (Number.isNaN(parsed.getTime())) {
          return String(raw || '-')
        }
        return parsed
          .toLocaleString('zh-CN', {
            timeZone: 'Asia/Shanghai',
            hour12: false,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
          })
          .replaceAll('/', '-')
      }

      function renderMeta(errorText) {
        const parts = []
        if (lastGeneratedAt) {
          parts.push('生成时间：' + formatBeijingTime(lastGeneratedAt))
        }
        parts.push('自动刷新：' + String(AUTO_REFRESH_MS / 1000) + '秒')
        if (errorText) {
          parts.push('最近刷新失败：' + errorText)
        }
        meta.textContent = parts.join(' | ')
      }

      function normalizeTask(task, index) {
        return {
          task_uid: String(task.task_uid || ''),
          display_id: String(task.display_id || ''),
          status: String(task.status || 'TODO').toUpperCase(),
          title: String(task.title || ''),
          done_record: String(task.done_record || ''),
          order: Number.isFinite(task.order) ? task.order : index + 1,
        }
      }

      function sortTasks(tasks) {
        return tasks.slice().sort((a, b) => {
          if (a.order !== b.order) {
            return a.order - b.order
          }
          return a.display_id.localeCompare(b.display_id, 'zh-CN')
        })
      }

      function fillStatusOptions() {
        const previous = statusSelect.value || 'ALL'
        statusSelect.innerHTML = STATUS_OPTIONS
          .map((status) => '<option value="' + status + '">' + (status === 'ALL' ? '全部状态' : status) + '</option>')
          .join('')
        statusSelect.value = STATUS_OPTIONS.includes(previous) ? previous : 'ALL'
      }

      function updateStats(tasks) {
        const counts = { DONE: 0, DOING: 0, TODO: 0, BLOCKED: 0 }
        for (const task of tasks) {
          if (counts[task.status] !== undefined) {
            counts[task.status] += 1
          }
        }
        statTotal.textContent = String(tasks.length)
        statDone.textContent = String(counts.DONE)
        statDoing.textContent = String(counts.DOING)
        statTodo.textContent = String(counts.TODO)
        statBlocked.textContent = String(counts.BLOCKED)
      }

      function renderTable(tasks) {
        tableBody.innerHTML = tasks
          .map((task) => {
            const doneRecord = task.done_record || '-'
            return [
              '<tr>',
              '<td class="mono">' + escapeHtml(task.display_id) + '</td>',
              '<td><span class="status status-' + escapeHtml(task.status) + '">' + escapeHtml(task.status) + '</span></td>',
              '<td>' + escapeHtml(task.title) + '</td>',
              '<td class="mono">' + escapeHtml(doneRecord) + '</td>',
              '</tr>',
            ].join('')
          })
          .join('')
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase()
        const selectedStatus = statusSelect.value

        const filtered = allTasks.filter((task) => {
          if (selectedStatus !== 'ALL' && task.status !== selectedStatus) {
            return false
          }
          if (!q) {
            return true
          }

          const haystack = [task.display_id, task.title, task.status, task.done_record]
            .join(' ')
            .toLowerCase()
          return haystack.includes(q)
        })

        updateStats(filtered)
        renderTable(filtered)
      }

      async function fetchTasks() {
        const response = await fetch('/api/tasks?ts=' + Date.now(), {
          cache: 'no-store',
        })

        if (!response.ok) {
          throw new Error('HTTP ' + String(response.status))
        }

        return response.json()
      }

      async function refreshTasks() {
        try {
          const payload = await fetchTasks()
          const tasks = Array.isArray(payload.tasks) ? payload.tasks : []

          allTasks = sortTasks(tasks.map(normalizeTask))
          lastGeneratedAt = payload.generatedAt || new Date().toISOString()

          fillStatusOptions()
          applyFilters()
          renderMeta('')
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error)
          renderMeta(message)
        }
      }

      fillStatusOptions()
      applyFilters()

      searchInput.addEventListener('input', applyFilters)
      statusSelect.addEventListener('change', applyFilters)

      if (window.location.protocol === 'file:') {
        meta.textContent = '请通过 npm run todo:board 启动本地看板服务。'
      } else {
        refreshTasks()
        window.setInterval(refreshTasks, AUTO_REFRESH_MS)
      }
    </script>
  </body>
</html>
